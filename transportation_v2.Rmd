---
title: "transportationV2"
author: "Andrew Salvador"
date: "10/30/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#options(scipen = 999)
```

```{r}
library(tidyverse)
library(tidyr)
library(janitor)
library(kableExtra)
library(car)
library(devtools)
library(broom)
library(ggpubr)
library(ggbeeswarm)
library(RColorBrewer)
library(effsize)
library(stargazer)
```

# Read in the data 
```{r}
all_data <- read_csv("2019_vendor_invoice.csv") %>% 
  clean_names() 

#all_data$vendor <- gsub("Left Coast Naturals", "Plenty and Spare", all_data$vendor)

```

Look at % spend for all suppliers
```{r}
all_spend_grouping <- all_data  %>% 
  group_by(vendor) %>% 
  summarise(cost = sum(total_cost)) %>% 
  arrange(-cost) %>% 
  mutate(pct_contribution = cost/sum(cost)*100) %>% 
  mutate(cumulative_pct = cumsum(pct_contribution)) %>% 
  mutate_if(is.numeric, ~round(., 1))
  
```

# Total of 108 suppliers in 2019
# 29 suppliers make up top 80% of spend
# Category A: Top 29 Suppliers 

Left Coast Naturals (1)
```{r}
distance01 <- all_data %>% 
  filter(grepl('Left Coast Naturals', vendor)) %>% 
  add_column(distance_km = 14)
  
```

Discovery Organics (2)
```{r}
distance02 <- all_data %>% 
  filter(grepl('Discovery Organics', vendor)) %>% 
  add_column(distance_km = 6.6)
```

Horizon Distributors (3)
```{r}
distance03 <- all_data %>% 
  filter(grepl('Horizon Distributors', vendor)) %>% 
  add_column(distance_km = 29.4)
```

Organic Matters (4)
```{r}
distance04 <- all_data %>% 
  filter(grepl('Organic Matters', vendor)) %>% 
  add_column(distance_km = 14)
```

LFT Group Brands Ltd. (5)
```{r}
distance05 <- all_data %>% 
  filter(grepl('LFT Group Brands Ltd.', vendor)) %>% 
  add_column(distance_km = 48.2)
```

Oneka Elements (6)
```{r}
distance06 <- all_data %>% 
  filter(grepl('Organic Matters', vendor)) %>% 
  add_column(distance_km = 1316)
```

Nelson Naturals	(7)
```{r}
distance07 <- all_data %>% 
  filter(grepl('Nelson Naturals', vendor)) %>% 
  add_column(distance_km = 1312)
```

Jiva Organics (8)
```{r}
distance08 <- all_data %>% 
  filter(grepl('Jiva Organics', vendor)) %>% 
  add_column(distance_km = 25.8)
```

Rehoboth Farm	(9)
```{r}
distance09 <- all_data %>% 
  filter(grepl('Rehoboth Farm', vendor)) %>% 
  add_column(distance_km = 178.6)
```

Dean's Milkman (10)
```{r}
distance10 <- all_data %>% 
  filter(grepl("Dean's Milkman", vendor)) %>% 
  add_column(distance_km = 105)
```

Westpoint Naturals (11)	
```{r}
distance11 <- all_data %>% 
  filter(grepl('Westpoint Naturals', vendor)) %>% 
  add_column(distance_km = 17.4)
```

Namasthé Tea Co. (12)
```{r}
distance12 <- all_data %>% 
  filter(grepl('Namasthé Tea Co.', vendor)) %>% 
  add_column(distance_km = 250)
```

Yoggu! (13)
```{r}
distance13 <- all_data %>% 
  filter(grepl('Yoggu!', vendor)) %>% 
  add_column(distance_km = 14.8)
```

Artisan Bake Shoppe	(14)
```{r}
distance14 <- all_data %>% 
  filter(grepl('Artisan Bake Shoppe', vendor)) %>% 
  add_column(distance_km = 21.4)
```


Onyx (15)
```{r}
distance15 <- all_data %>% 
  filter(grepl('Onyx', vendor)) %>% 
  add_column(distance_km = 15.2)
```

Hoochy ‘Booch Kombucha (16)
```{r}
distance16 <- all_data %>% 
  filter(grepl('Hoochy ‘Booch Kombucha', vendor)) %>% 
  add_column(distance_km = 4)
```

Brush Naked	(17)
```{r}
distance17 <- all_data %>% 
  filter(grepl('Brush Naked', vendor)) %>% 
  add_column(distance_km = 776)
```

East Van Roasters (18)
```{r}
distance18 <- all_data %>% 
  filter(grepl('East Van Roasters', vendor)) %>% 
  add_column(distance_km = 6.4)
```

Earnest Ice Cream	(19)
```{r}
distance19 <- all_data %>% 
  filter(grepl('Earnest Ice Cream', vendor)) %>% 
  add_column(distance_km = 6.4)
```

ULINE	(20)
```{r}
distance20 <- all_data %>% 
  filter(grepl('ULINE', vendor)) %>% 
  add_column(distance_km = 8648)
```

Plenty + Spare (21) YEEEEEEEEEEEEEET
```{r}
distance21 <- all_data %>% 
  filter(grepl("Plenty + Spare", vendor)) %>% 
  add_column(distance_km = 8.8)
```

Nellie's All-Natural (22)
```{r}
distance22 <- all_data %>% 
  filter(grepl("Nellie's All-Natural", vendor)) %>% 
  add_column(distance_km = 21.2)
```

The Modern Pantry	(23)
```{r}
distance23 <- all_data %>% 
  filter(grepl("The Modern Pantry", vendor)) %>% 
  add_column(distance_km = 21)
```

Dickie's Ginger	(24)
```{r}
distance24 <- all_data %>% 
  filter(grepl("Dickie's Ginger", vendor)) %>% 
  add_column(distance_km = 5.2)
```

Klippers Organics (25)
```{r}
distance25 <- all_data %>% 
  filter(grepl("Klippers Organics", vendor)) %>% 
  add_column(distance_km = 704)
```

A Bread Affair (26)
```{r}
distance26 <- all_data %>% 
  filter(grepl("A Bread Affair", vendor)) %>% 
  add_column(distance_km = 9.6)
```

Gathering Place Trading Company	(27)
```{r}
distance27 <- all_data %>% 
  filter(grepl("Gathering Place Trading Company", vendor)) %>% 
  add_column(distance_km = 528)
```

Fairware (28)
```{r}
distance28 <- all_data %>% 
  filter(grepl("Fairware", vendor)) %>% 
  add_column(distance_km = 4)
```

Nina's Pierogi (29)
```{r}
distance29 <- all_data %>% 
  filter(grepl("Nina's Pierogi", vendor)) %>% 
  add_column(distance_km = 83)
```

# Bind all DF's together
```{r}
combined_DF_distance <- rbind(distance01, distance02, distance03, distance04, distance05, distance06, distance07, distance08, distance09, distance10, distance11, distance12, distance13, distance14, distance15, distance16, distance17, distance18, distance19, distance20, distance21,distance22, distance23, distance24, distance25, distance26, distance27, distance28, distance29)
```


# Group by purchase order# so each row = one shipment there and back from the vendor
```{r}
purchaseorder_distance <- combined_DF_distance %>% 
  group_by(purchase_order, vendor) %>% 
  summarize(distance_km = mean(distance_km)) #use 'mean" cause I want a the single value of 1 trip (there & back)
```

# Count Purchase Orders by Vendor to see number of orders per vendor
```{r}
trips_by_vendor <- purchaseorder_distance %>% 
  group_by(vendor) %>% 
  summarise(trips = n()) %>% 
  arrange(desc(trips))
```

# Calculate emissions for transportation 
```{r}
emissions_transport <- purchaseorder_distance %>% 
  group_by(vendor) %>%
  summarize(sum_distance_km = sum(distance_km)) %>% # Sum total distance by ecah vendor
  arrange(desc(sum_distance_km)) %>%  # Group by vendor to see total distance by each vendor, arrange in descending order of total distance
  mutate(total_miles = sum(sum_distance_km)*0.621371) %>% # calculate total miles (to use in other calcs)
  mutate(kg_CO2_pergal = 8.78) %>% # See note (2): 8.78 kgCO2 / gal from EPA motor gasoline
  mutate(kg_CH4_perkm = 0.000020692) %>% # Emission factor calculated in note (3) 
  mutate(kg_N2O_perkm = 0.0000083264) %>% # Emission factor calculated in note (3)
  mutate(kgCO2 = sum_distance_km/10.46*kg_CO2_pergal) %>% # See note (1): Calculate transportation emissions for CO2 for each vendor
  mutate(kg_CO2e_CH4 = kg_CH4_perkm*sum_distance_km*28) %>% # Calculate CO2e for CH4, GWP 28
  mutate(kg_CO2e_N2O = kg_N2O_perkm*sum_distance_km*265) %>% # Calculate CO2e for N2O, GWP 265
  mutate(kg_CO2e = kg_CO2e_CH4 + kg_CO2e_N2O + kgCO2) %>% # Sum CO2e for CO2 + N2O + CH4
  mutate(total_kgCO2e = sum(kg_CO2e)) %>%  # Sum total transportation emissions for Nada
  mutate(pct_contribution = kg_CO2e/total_kgCO2e*100) %>% # See percent contribution to emissions by supplier
  mutate(cumulative_pct_emissions = cumsum(pct_contribution)) %>% # See cumulative percent contribution
  mutate_if(is.numeric, ~round(., 3)) # Round to 3 decimal places
  
```

# Filter (for fun) purchase order distance to eliminate suppliers >50km, then re-calculate total emissions

```{r}
local <- purchaseorder_distance %>% 
  filter(distance_km <50) %>% 
  group_by(vendor) %>%
  summarize(sum_distance = sum(distance_km)) %>% # Sum total distance by each vendor
  arrange(desc(sum_distance)) %>%  # Group by vendor to see total distance by each vendor, arrange in descending order of total distance
  mutate(kg_CO2_pergal = 8.78) %>% # See note (2): 8.78 kgCO2 / gal from EPA motor gasoline
  mutate(kg_CH4_perkm = 0.000020692) %>% # Emission factor calculated in note (3) 
  mutate(kg_N2O_perkm = 0.0000083264) %>% # Emission factor calculated in note (3)
  mutate(kgCO2 = sum_distance/10.46*kg_CO2_pergal) %>% # See note (1): Calculate transportation emissions for CO2 for each vendor
  mutate(kg_CO2e_CH4 = kg_CH4_perkm*sum_distance*28) %>% # Calculate CO2e for CH4, GWP 28
  mutate(kg_CO2e_N2O = kg_N2O_perkm*sum_distance*265) %>% # Calculate CO2e for N2O, GWP 265
  mutate(kg_CO2e = kg_CO2e_CH4 + kg_CO2e_N2O + kgCO2) %>% # Sum CO2e for CO2 + N2O + CH4
  mutate(total_kgCO2e = sum(kg_CO2e)) %>%  # Sum total transportation emissions for Nada
  mutate(pct_contribution = kg_CO2e/total_kgCO2e*100) %>% # See percent contribution to emissions by supplier
  mutate(cumulative_pct_emissions = cumsum(pct_contribution)) %>% # See cumulative percent contribution
  mutate_if(is.numeric, ~round(., 3))
```


NOTES: 
(1) Using 'delivery truck' fuel economy (6.5mpg) from here:
https://afdc.energy.gov/data/10310 

6.5miles/gallon = 10.46 km / gallon

x km / 10.46km per gallon = left with gallons
Multiply gallons by 8.78 kg CO2/gallon to get kg CO2 

According to https://business.edf.org/insights/green-freight-math-how-to-calculate-emissions-for-a-truck-move/
Freight Truck emission factor = 161.8 g / ton-mile or 0.1618 kg / ton-mile
  - As currently calculated (using straight-up miles), Nada's suppliers would emit ~1.35 kg / mile (total kg CO2e/total_miles). This number is much higher than the 'ton-mile' emission factor, although, if we assumed that each truck carried about 8.5 tons, then the 'ton-mile' factor (8.5tons*0.1618 kg/ton-mile ~ 1.37 kg/mile ) becomes almost the same as currently calculated. I guess if we used ton-mile, the emissions for transport would depend heavily on the assumed amount of weight each truck is carrying. 

(2) Mobile combustion CO2 'motor gasoline' emission factor (8.78kgCO2/gallon) from EPA:  https://www.epa.gov/sites/production/files/2018-03/documents/emission-factors_mar_2018_0.pdf


(3) Gasoline Heavy Duty Vehicles EPA emission factors CH4 & N2O
2008-present
CH4: 0.0333 g/ mile (1 mile / 1.60934 km) = 0.020692 g / km = 0.000020692 kg CH4 / km 
N2O: 0.0134 g/ mile (1 mile / 1.60934 km) = 0.0083264 g / km = 0.0000083264 kg N2O / km













# Step by step explanation of above (emissions_transport), can be deleted later 
# Group by vendor to see emissions by each vendor, arrange in descending order of total distance
```{r}
#vendor_transport_distance <- purchaseorder_distance %>% 
  #group_by(vendor) %>% 
  #summarize(sum_distance = sum(distance_km)) %>% 
  #arrange(desc(sum_distance))
```

# Calculate transportation emissions for CO2 for each vendor 
```{r}
#vendor_emissions <- vendor_transport_distance %>% 
  #mutate(emission_factor_CO2 = 2.5) %>% 
  #mutate(kgco2e = emission_factor_CO2*sum_distance)
```
 
# Sum total transportation emissions for Nada
```{r}
#total_emissions <- vendor_emissions %>% 
  #mutate(total_kgco2e = sum(kgco2e))
  
```